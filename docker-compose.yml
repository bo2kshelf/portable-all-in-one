version: "3.7"

services:
  # imageproxy
  imageproxy:
    restart: always
    image: willnorris/imageproxy@sha256:7e4c77d1b64db9152591dbfd8565d5d377eb8a243040efa4e241b97ba94feb1d
    networks:
      - imageproxy
    ports:
      - published: ${IMAGEPROXY_PORT}
        target: 8080
    depends_on:
      imageproxy-redis:
        condition: service_healthy
    environment:
      IMAGEPROXY_CACHE: redis://imageproxy-redis:6379

  imageproxy-redis:
    restart: always
    image: redis:6@sha256:e10f55f92478715698a2cef97c2bbdc48df2a05081edd884938903aa60df6396
    healthcheck: &redis-healthcheck
      test: ["CMD", "redis-cli", "ping"]
      interval: 1s
      timeout: 3s
      retries: 30
    networks:
      - imageproxy
    volumes:
      - imageproxy-redis-data:/data

  # for development tools
  adminer:
    restart: always
    image: adminer:standalone@sha256:370c04eb26f585c408986d89d1d9c5e62f387d4afdd5a49aa13f7c5f53790262
    networks:
      - papi-users-mysql
    ports:
      - published: $ADMINER_PORT
        target: 8080
    environment:
      ADMINER_DESIGN: $ADMINER_DESIGN

  # public-api
  public-api-gateway:
    restart: always
    image: ghcr.io/bo2kshelf/public-api-gateway:develop@sha256:ea7e33f9a076a20ff7a0a434633729c35dcb7604162a87efabfd672bbe779559
    depends_on:
      papi-bookcover-service:
        condition: service_started
      papi-read-users-service:
        condition: service_started
      papi-read-contents-service:
        condition: service_started
      papi-read-records-service:
        condition: service_started
    networks:
      - papi-read-users
      - papi-read-contents
      - papi-read-records
      - papi-bookcover
    ports:
      - published: ${PUBLIC_API_PORT}
        target: 4000
    environment:
      PORT: 4000
      BOOKCOVER_SERVICE_URL: http://papi-bookcover-service:4000/graphql
      READ_USERS_SERVICE_URL: http://papi-read-users-service:4000/graphql
      READ_CONTENTS_SERVICE_URL: http://papi-read-contents-service:4000/graphql
      READ_RECORDS_SERVICE_URL: http://papi-read-records-service:4000/graphql

  papi-read-users-service:
    restart: always
    image: ghcr.io/bo2kshelf/read-users-service:develop@sha256:04ce0b1215636e1a05b4f47f742f02605c752c2f43ef5d709add3f0b2b6f167b
    depends_on:
      papi-users-mysql:
        condition: service_healthy
    networks:
      - imageproxy
      - papi-read-users
    environment:
      PORT: 4000
      PRISMA_DATABASE_URL: mysql://root:${PAPI_USERS_MYSQL_ROOT_PASSWORD}@papi-users-mysql:3306/${PAPI_USERS_MYSQL_DATABASE}
      IMAGEPROXY_BASE_URL: $IMAGEPROXY_BASE_URL

  papi-users-mysql:
    restart: always
    image: mysql:8.0@sha256:04ee7141256e83797ea4a84a4d31b1f1bc10111c8d1bc1879d52729ccd19e20a
    networks:
      - papi-users-mysql
      - papi-read-users
    environment:
      MYSQL_ROOT_PASSWORD: ${PAPI_USERS_MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${PAPI_USERS_MYSQL_DATABASE}
    volumes:
      - papi-read-users-mysql-data:/var/lib/mysql
    healthcheck: &mysql-healthcheck
      test: "mysqladmin ping -h localhost"
      interval: 10s
      timeout: 20s
      retries: 10

  papi-read-contents-service:
    restart: always
    image: ghcr.io/bo2kshelf/read-contents-service:develop@sha256:97a0a55e3b970dcd32da69f2ed8c8d3238dfc429bdf33a84f862ed7a995e28a5
    depends_on:
      papi-neo4j:
        condition: service_healthy
    networks:
      - papi-neo4j
      - papi-read-contents
    environment:
      PORT: 4000
      NEO4J_URL: bolt://papi-neo4j:7687
      NEO4J_USERNAME: ${PAPI_NEO4J_USERNAME}
      NEO4J_PASSWORD: ${PAPI_NEO4J_PASSWORD}

  papi-read-records-service:
    restart: always
    image: ghcr.io/bo2kshelf/read-records-service:develop@sha256:5f00a6f8af47c76663e9c14f70cfc08d6499ee65085befe0b33ca2cd8f0a270d
    depends_on:
      papi-neo4j:
        condition: service_healthy
    networks:
      - papi-neo4j
      - papi-read-records
    environment:
      PORT: 4000
      NEO4J_URL: bolt://papi-neo4j:7687
      NEO4J_USERNAME: ${PAPI_NEO4J_USERNAME}
      NEO4J_PASSWORD: ${PAPI_NEO4J_PASSWORD}

  papi-neo4j:
    restart: always
    image: neo4j:4.2@sha256:699af10b322f66d45e42b19dfbab752e09801169165a756c60254bf66c5d2c15
    networks:
      - papi-neo4j
    healthcheck: &neo4j-healthcheck
      test: wget http://localhost:7474/browser -O-
      interval: 5s
      timeout: 3s
      retries: 30
    environment:
      NEO4J_AUTH: ${PAPI_NEO4J_USERNAME}/${PAPI_NEO4J_PASSWORD}
      NEO4JLABS_PLUGINS: '["apoc"]'
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"
    volumes:
      - papi-neo4j-data:/data
      - papi-neo4j-logs:/logs
      - papi-neo4j-import:/var/lib/neo4j/import
      - papi-neo4j-plugins:/plugins

  papi-bookcover-service:
    restart: always
    image: ghcr.io/bo2kshelf/bookcover-service:develop@sha256:b18da695a196e9665e562eace65d65f669620a554607c87fc3a4573594769a07
    networks:
      - papi-bookcover
      - imageproxy
    depends_on:
      papi-bookcover-service-redis:
        condition: service_healthy
    environment:
      PORT: 4000
      RAKUTEN_APPLICATION_ID: $RAKUTEN_APPLICATION_ID
      RAKUTEN_APPLICATION_SECRET: $RAKUTEN_APPLICATION_SECRET
      IMAGEPROXY_BASE_URL: $IMAGEPROXY_BASE_URL
      REDIS_HOST: papi-bookcover-service-redis
      REDIS_PORT: 6379

  papi-bookcover-service-redis:
    restart: always
    image: redis:6@sha256:e10f55f92478715698a2cef97c2bbdc48df2a05081edd884938903aa60df6396
    healthcheck: *redis-healthcheck
    networks:
      - papi-bookcover
    volumes:
      - papi-bookcover-service-redis-data:/data

  # management
  management-api-gateway:
    restart: always
    image: ghcr.io/bo2kshelf/management-api-gateway:develop@sha256:dabb3121952b1e90ba0913e94a8c85dd77947e0acb86bc2164a8e7510766d6fd
    depends_on:
      mapi-read-contents-service:
        condition: service_started
      mapi-edit-contents-service:
        condition: service_started
      mapi-bookcover-service:
        condition: service_started
    networks:
      - mapi-read-contents
      - mapi-edit-contents
      - mapi-bookcover
    ports:
      - published: ${MANAGEMENT_API_PORT}
        target: 4000
    environment:
      PORT: 4000
      READ_CONTENTS_SERVICE_URL: http://mapi-read-contents-service:4000/graphql
      EDIT_CONTENTS_SERVICE_URL: http://mapi-edit-contents-service:4000/graphql
      BOOKCOVER_SERVICE_URL: http://mapi-bookcover-service:4000/graphql

  mapi-read-contents-service:
    restart: always
    image: ghcr.io/bo2kshelf/read-contents-service:develop@sha256:97a0a55e3b970dcd32da69f2ed8c8d3238dfc429bdf33a84f862ed7a995e28a5
    depends_on:
      mapi-neo4j:
        condition: service_healthy
    networks:
      - mapi-neo4j
      - mapi-read-contents
    environment:
      PORT: 4000
      NEO4J_URL: bolt://mapi-neo4j:7687
      NEO4J_USERNAME: ${MAPI_NEO4J_USERNAME}
      NEO4J_PASSWORD: ${MAPI_NEO4J_PASSWORD}

  mapi-edit-contents-service:
    restart: always
    image: ghcr.io/bo2kshelf/edit-contents-service:develop@sha256:7f8653677f40414c88a9ec183a11bb24c3c3fec8c325c582002cbda3458a607b
    depends_on:
      mapi-neo4j:
        condition: service_healthy
    networks:
      - mapi-neo4j
      - mapi-edit-contents
    environment:
      PORT: 4000
      NEO4J_URL: bolt://mapi-neo4j:7687
      NEO4J_USERNAME: ${MAPI_NEO4J_USERNAME}
      NEO4J_PASSWORD: ${MAPI_NEO4J_PASSWORD}

  mapi-neo4j:
    restart: always
    image: neo4j:4.2@sha256:699af10b322f66d45e42b19dfbab752e09801169165a756c60254bf66c5d2c15
    networks:
      - mapi-neo4j
    healthcheck: *neo4j-healthcheck
    environment:
      NEO4J_AUTH: ${MAPI_NEO4J_USERNAME}/${MAPI_NEO4J_PASSWORD}
      NEO4JLABS_PLUGINS: '["apoc"]'
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"
    volumes:
      - mapi-neo4j-data:/data
      - mapi-neo4j-logs:/logs
      - mapi-neo4j-import:/var/lib/neo4j/import
      - mapi-neo4j-plugins:/plugins

  mapi-bookcover-service:
    restart: always
    image: ghcr.io/bo2kshelf/bookcover-service:develop@sha256:b18da695a196e9665e562eace65d65f669620a554607c87fc3a4573594769a07
    networks:
      - imageproxy
      - mapi-bookcover
    depends_on:
      papi-bookcover-service-redis:
        condition: service_healthy
    environment:
      PORT: 4000
      RAKUTEN_APPLICATION_ID: $RAKUTEN_APPLICATION_ID
      RAKUTEN_APPLICATION_SECRET: $RAKUTEN_APPLICATION_SECRET
      IMAGEPROXY_BASE_URL: $IMAGEPROXY_BASE_URL
      REDIS_HOST: mapi-bookcover-service-redis
      REDIS_PORT: 6379

  mapi-bookcover-service-redis:
    restart: always
    image: redis:6@sha256:e10f55f92478715698a2cef97c2bbdc48df2a05081edd884938903aa60df6396
    healthcheck: *redis-healthcheck
    networks:
      - mapi-bookcover
    volumes:
      - mapi-bookcover-service-redis-data:/data

volumes:
  imageproxy-redis-data:
  users-api-mysql-data:
  bookcover-api-redis-data:
  neo4j-api-neo4j-data:
  neo4j-api-neo4j-logs:
  neo4j-api-neo4j-import:
  neo4j-api-neo4j-plugins:
  search-api-elasticsearch:
  auth-server-mongo-data:
  auth-server-postgresql-data:
  # public
  papi-read-users-mysql-data:
  papi-neo4j-data:
  papi-neo4j-logs:
  papi-neo4j-import:
  papi-neo4j-plugins:
  papi-bookcover-service-redis-data:
  # management
  mapi-neo4j-data:
  mapi-neo4j-logs:
  mapi-neo4j-import:
  mapi-neo4j-plugins:
  mapi-bookcover-service-redis-data:

networks:
  # imageproxy
  imageproxy:
    driver: bridge

  # public
  papi-read-users:
    driver: bridge
  papi-users-mysql:
    driver: bridge
  papi-read-contents:
    driver: bridge
  papi-read-records:
    driver: bridge
  papi-neo4j:
    driver: bridge
  papi-bookcover:
    driver: bridge

  # management
  mapi-read-contents:
    driver: bridge
  mapi-edit-contents:
    driver: bridge
  mapi-neo4j:
    driver: bridge
  mapi-bookcover:
    driver: bridge
